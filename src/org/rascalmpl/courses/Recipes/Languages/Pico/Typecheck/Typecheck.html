<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
  <html xmlns="http://www.w3.org/1999/xhtml">

<!---- DO NOT EDIT: HTML generated by CourseCompiler ---->


<head>
<title>Recipes/Languages/Pico/Typecheck</title>

<meta name="description" content="Recipes/Languages/Pico/Typecheck:  Typechecker a Pico program.">

<meta name="keywords" content="Recipes/Languages/Pico/Typecheck, Rascal, meta-programming, software analysis, software transformation">
<link type="text/css" rel="stylesheet" href="/prelude.css"/>
<link type="text/css" rel="stylesheet" href="/jquery.autocomplete.css"/>
<script type="text/javascript" src="/jquery-1.4.2.min.js"></script>
<script type="text/javascript" src="/jquery.colorbox-min.js"></script>
<script type="text/javascript" src="/jquery.cookie.js"></script>
<script type="text/javascript" src="/jquery.jstree.js"></script>
<script type="text/javascript" src="/jquery.autocomplete.js"></script>
<script type="text/javascript" src="/jquery.history.js"></script>
<script type="text/javascript" src="/globals.js"></script>
<script type="text/javascript" src="/prelude.js"></script>
<script type="text/javascript" src="/Recipes/course.js"></script>

</head>
<body>
<table id="container"><tr><td id="tdlogo"><a id="tutorAction" href="/index.html"><img id="leftIcon" height="40" width="40" src="/images/rascal-tutor-small.png"></a></td><td id="tdsearch">
<div id="searchBox">
  <form method="GET" id="searchForm" action="/search"> 
    <img id="searchIcon" height="20" width="20" src="/images/magnify.png">
    <input type="hidden" name="concept" value="Recipes/Languages/Pico/Typecheck">
    <input type="text" id="searchField" name="term" autocomplete="off"><br />
    <div id="popups"></div>
  </form>
</div>
         </td></tr><tr><td id="tdnav">
<a id="navPanePlaceHolder" href="/Recipes/navigate.html" >Navigation</a>
<script type="text/javascript"> var navigationPaneSource="/Recipes/navigate.html"; </script></td><td id="tdconcept">
<div id="conceptPane">

<div id="Name">
<span class="sectionHead">Name</span> <a href="/Recipes/Recipes.html">Recipes</a>/<a href="/Recipes/Languages/Languages.html">Languages</a>/<a href="/Recipes/Languages/Pico/Pico.html">Pico</a>/<a href="/Recipes/Languages/Pico/Typecheck/Typecheck.html">Typecheck</a>
</div>

<div id="Synopsis">
<span class="sectionHead">Synopsis</span>  Typechecker a Pico program.

</div>

	                       
                           
                           
                           
  	                       
<div id="Examples">
<span class="sectionHead">Examples</span>  Recall the following properties of Pico that are relevant for type checking:
  <ul><li> There are two types: natural numbers and strings.</li>
<li> Variables have to be declared.</li>
<li> Expressions may contain naturals, strings, variables, addition (<code>+</code>), subtraction (<code>-</code>) and concatenation (<code>||</code>).</li>
<li> The operators <code>+</code> and <code>-</code> have operands of type natural and their result is natural.</li>
<li> The operator <code>||</code> has operands of type string and its results is also of type string.</li>
<li> Tests in if-then-else statement and while-statement should be of type natural.</li>
</ul> The type checker is going to check these rules and will produce an error message when they are violated.
  <pre class="listing">module demo::lang::Pico::Typecheck

import Prelude;
import demo::lang::Pico::Abstract;
import demo::lang::Pico::Load;

alias TENV = tuple[ map[PicoId, TYPE] symbols, list[tuple[loc l, str msg]] errors]; <img src="/images/1.png">

TENV addError(TENV env, loc l, str msg) = env[errors = env.errors + &lt;l, msg>];      <img src="/images/2.png">

str required(TYPE t, str got) = "Required &lt;getName(t)>, got &lt;got>";                 <img src="/images/3.png">
str required(TYPE t1, TYPE t2) = required(t1, getName(t2));

// compile Expressions.

TENV checkExp(exp:natCon(int N), TYPE req, TENV env) =                              <img src="/images/4.png">
  req == natural() ? env : addError(env, exp@location, required(req, "natural"));

TENV checkExp(exp:strCon(str S), TYPE req, TENV env) =
 req == string() ? env : addError(env, exp@location, required(req, "string"));

TENV checkExp(exp:id(PicoId Id), TYPE req, TENV env) {                              <img src="/images/5.png">
  if(!env.symbols[Id]?)
     return addError(env, exp@location, "Undeclared variable &lt;Id>");
  tpid = env.symbols[Id];
  return req == tpid ? env : addError(env, exp@location, required(req, tpid));
}

TENV checkExp(exp:add(EXP E1, EXP E2), TYPE req, TENV env) =                        <img src="/images/6.png">
  req == natural() ? checkExp(E1, natural(), checkExp(E2, natural(), env))
                   : addError(env, exp@location, required(req, "natural"));
  
TENV checkExp(exp:sub(EXP E1, EXP E2), TYPE req, TENV env) =                      
  req == natural() ? checkExp(E1, natural(), checkExp(E2, natural(), env))
                   : addError(env, exp@location, required(req, "natural"));

TENV checkExp(exp:conc(EXP E1, EXP E2), TYPE req, TENV env) =                    
  req == string() ? checkExp(E1, string(), checkExp(E2, string(), env))
                   : addError(env, exp@location, required(req, "string"));


// check a statement

TENV checkStat(stat:asgStat(PicoId Id, EXP Exp), TENV env) {                        <img src="/images/9.png">
  if(!env.symbols[Id]?)
     return addError(env, stat@location, "Undeclared variable &lt;Id>");
  tpid = env.symbols[Id];
  return checkExp(Exp, tpid, env);
}
	
TENV checkStat(stat:ifElseStat(EXP Exp,                                             <img src="/images/10.png">
                              list[STATEMENT] Stats1,
                              list[STATEMENT] Stats2),
               TENV env){
    env0 = checkExp(Exp, natural(), env);
    env1 = checkStats(Stats1, env0);
    env2 = checkStats(Stats2, env1);
    return env2;
}

TENV checkStat(stat:whileStat(EXP Exp, 
                             list[STATEMENT] Stats1),
                 TENV env) {
    env0 = checkExp(Exp, natural(), env);
    env1 = checkStats(Stats1, env0);
    return env1;
}

// check a list of statements
TENV checkStats(list[STATEMENT] Stats1, TENV env) {                                 <img src="/images/11.png">
  for(S &lt;- Stats1){
      env = checkStat(S, env);
  }
  return env;
}
  
// check declarations

TENV checkDecls(list[DECL] Decls) =                                                 <img src="/images/12.png">
    &lt;( Id : tp  | decl(PicoId Id, TYPE tp) &lt;- Decls), []>;

// check a Pico program

public TENV checkProgram(PROGRAM P){                                                <img src="/images/13.png">
  if(program(list[DECL] Decls, list[STATEMENT] Series) := P){
     TENV env = checkDecls(Decls);
     return checkStats(Series, env);
  } else
    throw "Cannot happen";
}
                                                                                    <img src="/images/14.png">
public list[tuple[loc l, str msg]] checkProgram(str txt) = checkProgram(load(txt)).errors;

    
</pre> Notes:
  <ul><li> We will use <code>TENV</code> (short for type environment, see <img src="/images/1.png">) as an alias for a tuple that contains all relevant type information: <ul><li> <code>symbols</code>: a map from Pico identifiers to their declared type.</li>
<li> <code>errors</code>: a list of error messages. An error message is represented by its location (where the error occurred) and a textual message.</li>
</ul></li>
<li> <code>addError</code> (<img src="/images/2.png">) is an auxiliary function to add in a given type environment an error message to the list of errors. It returns a new type environment.</li>
<li> <code>required</code> (<img src="/images/3.png">) is an auxiliarty function to produce readable messages, e.g., <code>"Required natural, got string"</code>.</li>
<li> The actual type checking is done by the functions <code>checkExp</code>, <code>checkStat</code>, <code>checkStats</code>, <code>checkDecls</code> and <code>checkProgram</code>. They all have three arguments: <ul><li> the program fragment (an abstract syntax tree) to be checked.</li>
<li> the required type of that fragment.</li>
<li> the type environment.</li>
</ul></li>
</ul> <ul><li> <code>checkExp</code> (<img src="/images/4.png">) checks expressions. For instance, checking a natural constant (<code>natCon</code>) is ok when type <code>natural</code> is expected but will give an error message when a <code>string</code> is expected. Observe how all the arguments of the check functions have a labeled pattern as first argument, here <code>exp:natCon(int N)</code>. The benefit is that the whole argument is available inside the function (as value of variable <code>exp</code>) and this can be used to retrieve the location information from it (<code>exp@location</code>) when an error has to be created.</li>
<li> An important case (<img src="/images/5.png">) is to check whether an identifier has been defined and, if so, whether it is defined with the expected type.</li>
<li> The types of operators in expressions are checked in <img src="/images/6.png"> and onwards.</li>
<li> At (<img src="/images/9.png">) an assignment statement is checked: the identifier on the left-hand side should have been declared and should be type compatible with the expression on the right-hand side.</li>
<li> Checking if- and while-statements (<img src="/images/10.png">) amounts to checking the embedded statements and ensuring that the type of the test is natural.</li>
<li> Checking a list of statements (<img src="/images/11.png">) amounts to checking each statement in the list.</li>
<li> Checking declarations (<img src="/images/12.png">) amounts to extracting each (id, type) pair form the declarations and using a map comprehension to build a type environment.</li>
<li> Checking a complete Pico program (<img src="/images/13.png">) is achieved by first checking the declarations of the program and using the resulting type environment to check its body.</li>
<li> <code>checkProgram</code> (<img src="/images/14.png">) defines how to check the source code of a given Pico program.</li>
</ul> Checking an erroneous program goes like this:
 <pre class="screen"><span class="prompt">rascal></span>import demo::lang::Pico::Typecheck;
ok
<span class="prompt">rascal></span>checkProgram(&quot;begin declare  x : natural; x := \&quot;abc\&quot; end&quot;);
lrel[loc l,str msg]: [&lt;|file://-|(33,5,&lt;1,33>,&lt;1,38>),"Required natural, got string">]
</pre> The error location will be use later to give specific messages in the IDE.

</div>

  	                       
  	                       
  	                       
<a id="tutorAction" href="/index.html"><img id="leftIcon" height="40" width="40" src="/images/rascal-tutor-small.png"></a><div id="editMenu">[<a id="editAction" href="/edit?concept=Recipes/Languages/Pico/Typecheck&new=false"><b>Edit</b></a>] | 
               [<a id="newAction" href="/edit?concept=Recipes/Languages/Pico/Typecheck&new=true"><b>New Subconcept</b></a>] |
               [<a id="compileAction" href="/compile?name=Recipes"><b>Recompile Course</b></a>] |
               [<a id="warnAction" href="/Recipes/warnings.html"><b>Warnings</b></a>]</div>
<span class="editMenuFooter">Is this page unclear, or have you spotted an error? Please add a comment below and help us to improve it. For all other questions and remarks, visit <a href="http://ask.rascal-mpl.org">ask.rascal-mpl.org</a>. </span>
</div>
</td></tr></table>
</body>
</html>